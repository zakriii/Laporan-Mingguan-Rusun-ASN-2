<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <!-- Judul bisa diedit -->
  <title id="doc-title">Template Laporan Mingguan - Rusun ASN</title>
  <!-- Memuat Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Memuat Google Font "Inter" -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <!-- MEMUAT LIBRARY CHART.JS -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <style>
    body { 
      font-family: 'Inter', sans-serif; 
      background-color: #f1f5f9; /* bg-slate-100 */
    }
    
    /* Kontainer halaman utama */
    .page {
      max-width: 1000px; 
      margin: 24px auto; 
      background: white; 
      border-radius: 12px; 
      padding: 32px; 
      box-shadow: 0 10px 30px rgba(0,0,0,0.08);
      border: 1px solid #e2e8f0;
    }
    
    /* Judul bagian */
    .section-heading {
      font-size: 1.1rem; /* 18px */
      font-weight: 600; /* semibold */
      color: #0f172a; /* DIUBAH: text-slate-900 (hitam pekat) */
      border-bottom: 2px solid #dbeafe; /* border-blue-100 */
      padding-bottom: 8px;
      margin-bottom: 16px;
    }

    /* Tombol Aksi */
    .btn {
      padding: 8px 16px;
      border-radius: 6px;
      color: white;
      font-weight: 500;
      transition: background-color 0.2s;
      cursor: pointer;
    }
    .btn-green { background-color: #16a34a; } /* green-600 */
    .btn-green:hover { background-color: #15803d; } /* green-700 */
    .btn-blue { background-color: #2563eb; } /* blue-600 */
    .btn-blue:hover { background-color: #1d4ed8; } /* blue-700 */
    .btn-red { background-color: #dc2626; } /* red-600 */
    .btn-red:hover { background-color: #b91c1c; } /* red-700 */
    .btn-gray { background-color: #475569; } /* slate-600 */
    .btn-gray:hover { background-color: #334155; } /* slate-700 */

    /* Tombol AI kecil */
    .btn-sm {
      padding: 4px 8px;
      font-size: 0.8rem;
    }

    /* Animasi spinner untuk loading AI */
    .spinner {
      border: 3px solid #f3f3f3; /* Light grey */
      border-top: 3px solid #3b82f6; /* Blue */
      border-radius: 50%;
      width: 16px;
      height: 16px;
      animation: spin 1s linear infinite;
      display: inline-block;
      margin-right: 6px;
      vertical-align: middle;
    }
    @keyframes spin { 
      0% { transform: rotate(0deg); } 
      100% { transform: rotate(360deg); } 
    }

    /* Gaya Tabel "Excel" */
    .excel-table {
      width: 100%;
      border-collapse: collapse;
      border: 1px solid #cbd5e1; /* slate-300 */
    }
    .excel-table th, .excel-table td {
      border: 1px solid #cbd5e1; /* slate-300 */
      padding: 8px;
      text-align: left;
      vertical-align: top;
      font-size: 0.9rem;
    }
    .excel-table th {
      background-color: #f1f5f9; /* slate-100 */
      font-weight: 600;
      color: #334155; /* slate-700 */
    }
    .excel-table td {
      background-color: #fff;
    }

    /* Input di dalam tabel */
    .table-input {
      width: 100%;
      padding: 6px 8px;
      border: 1px solid #cbd5e1; /* slate-300 */
      border-radius: 4px;
      font-size: 0.9rem;
    }
    .table-input:focus {
      outline: none;
      border-color: #2563eb; /* blue-600 */
      box-shadow: 0 0 0 1px #2563eb;
    }
    .table-textarea {
      width: 100%;
      min-height: 60px;
      padding: 6px 8px;
      border: 1px solid #cbd5e1; /* slate-300 */
      border-radius: 4px;
      font-size: 0.9rem;
    }
    .table-textarea:focus {
      outline: none;
      border-color: #2563eb; /* blue-600 */
      box-shadow: 0 0 0 1px #2563eb;
    }

    /* Input formulir biasa */
    .form-input-line {
      width: 100%;
      border: none;
      border-bottom: 2px solid #e2e8f0; /* slate-200 */
      padding: 8px 4px;
      background: transparent;
    }
    .form-input-line:focus {
      outline: none;
      border-color: #2563eb; /* blue-600 */
    }
    
    .form-textarea-box {
      width: 100%;
      border: 1px solid #cbd5e1; /* slate-300 */
      border-radius: 6px;
      padding: 10px;
      background: #f8fafc; /* slate-50 */
    }
    .form-textarea-box:focus {
      outline: none;
      border-color: #2563eb; /* blue-600 */
      box-shadow: 0 0 0 1px #2563eb;
      background: #fff;
    }

    /* Gaya upload file */
    .form-input-file {
      font-size: 0.9rem;
    }
    .form-input-file-small {
      font-size: 0.8rem;
    }

    /* Kontainer preview gambar */
    .image-preview-container {
      margin-top: 8px;
      border: 1px solid #e2e8f0; /* slate-200 */
      border-radius: 6px;
      padding: 8px;
      background-color: #f8fafc; /* slate-50 */
    }
    .image-preview {
      max-width: 100%;
      max-height: 200px;
      height: auto;
      border-radius: 4px;
      object-fit: contain; /* Penting agar gambar tidak terdistorsi */
      margin: 0 auto; /* Pusatkan gambar */
      display: block;
    }

    /* Kotak Tanda Tangan Horizontal */
    .signature-box {
      border: 1px dashed #cbd5e1; /* border-slate-300 */
      border-radius: 8px;
      padding: 8px;
      display: flex;
      flex-direction: column;
      height: 200px; /* Tinggi tetap untuk kotak TTD */
      background-color: #f8fafc; /* bg-slate-50 */
    }
    .signature-box .image-preview-container {
      height: 100%; /* Ambil sisa tinggi */
      min-height: 100px; /* Tinggi minimum */
      display: flex; /* Ditambahkan untuk memusatkan img */
      justify-content: center;
      align-items: center;
      border: none;
      background-color: transparent;
      padding: 0;
    }
    .signature-box .image-preview {
      max-height: 100%; /* Pastikan gambar pas di dalam container */
      width: auto;
      max-width: 100%;
    }


    /* Aturan cetak (print) */
    @media print {
      body {
        background-color: white;
        font-family: 'Times New Roman', Times, serif;
      }
      .page {
        margin: 0;
        padding: 0;
        border: none;
        box-shadow: none;
        max-width: 100%;
      }
      .no-print {
        display: none !important;
      }
      .form-input-line, .form-textarea-box, .table-input, .table-textarea {
        border: none !important;
        box-shadow: none !important;
        padding-left: 0;
        padding-right: 0;
        background: transparent !important;
      }
      .form-textarea-box, .table-textarea {
        min-height: auto; /* Biarkan konten menentukan tinggi */
      }
      .image-preview-container {
        border: none !important;
        padding: 0 !important;
        background: transparent !important;
      }
      .image-preview {
        max-height: 150px !important; /* Batasi tinggi gambar saat cetak */
      }
      .excel-table {
        border: 1px solid #999;
      }
      .excel-table th, .excel-table td {
        border: 1px solid #999;
      }
      .excel-table th {
        background-color: #eee !important;
        -webkit-print-color-adjust: exact; /* Paksa cetak warna latar */
        color-adjust: exact;
      }
      
      /* Pastikan grafik tidak tercetak */
      #recapChartContainer, #dailyTrendChartContainer, #crewChartContainer {
        display: none !important;
      }

      .signature-box {
        border: 1px solid #999;
        height: 180px;
        background: transparent !important;
        page-break-inside: avoid;
      }
    }
  </style>
</head>
<body class="bg-slate-100">

  <!-- Tombol Aksi Global (Sticky) -->
  <div class="no-print sticky top-0 z-50 bg-white/80 backdrop-blur-sm shadow-md p-3">
    <div class="max-w-5xl mx-auto flex justify-between items-center">
      <h2 class="text-lg font-semibold text-slate-800">Mode Edit Laporan</h2>
      
      <!-- Dibungkus dengan div untuk tata letak tombol -->
      <div class="flex items-center gap-3">
        <!-- TOMBOL BARU: Download HTML -->
        <button onclick="downloadHTML()" class="btn btn-blue flex items-center">
          <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
          Download HTML
        </button>
        
        <!-- Tombol Print / PDF yang sudah ada -->
        <button onclick="window.print()" class="btn btn-green flex items-center">
          <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M5 4v3H4a2 2 0 00-2 2v3a2 2 0 002 2h1v3a2 2 0 002 2h6a2 2 0 002-2v-3h1a2 2 0 002-2V9a2 2 0 00-2-2h-1V4a2 2 0 00-2-2H7a2 2 0 00-2 2zm8 0H7v3h6V4zm0 8H7v3h6v-3z" clip-rule="evenodd"></path></svg>
          Print / Simpan PDF
        </button>
      </div>

    </div>
  </div>

  <div class="page">
    <!-- Header -->
    <header class="mb-8">
      <div class="flex justify-between items-center mb-4">
        <!-- Logo Kiri (OIKN) -->
        <div class="w-1/4">
          <input type="file" class="form-input-file-small no-print" accept="image/*" onchange="previewFile(this, 'logo-oikn')">
          <div id="logo-oikn" class="image-preview-container hidden">
            <img src="" alt="Preview Logo OIKN" class="image-preview !max-h-[100px]">
          </div>
        </div>
        
        <!-- Judul Laporan (Bisa Diedit) -->
        <div class="w-1/2 text-center">
          <textarea id="report-title" class="form-textarea-box text-xl font-bold text-center !border-none !shadow-none !bg-transparent" rows="2">LAPORAN KEGIATAN MINGGUAN PENGELOLAAN HUNIAN RUSUN ASN</textarea>
        </div>
        
        <!-- Logo Kanan (Perusahaan) -->
        <div class="w-1/4">
          <input type="file" class="form-input-file-small no-print" accept="image/*" onchange="previewFile(this, 'logo-perusahaan')">
          <div id="logo-perusahaan" class="image-preview-container hidden">
            <img src="" alt="Preview Logo Perusahaan" class="image-preview !max-h-[100px]">
          </div>
        </div>
      </div>
      
      <!-- Paragraf Kontrak (Bisa Diedit) -->
      <textarea class="form-textarea-box text-sm text-slate-700" rows="4" placeholder="[Paragraf Kontrak - bisa diedit]... Berdasarkan Surat Perjanjian Kontrak Nomor...">Berdasarkan Surat Perjanjian Kontrak Nomor PRJ-20/OIKN.PPK-XIX/2025 tanggal 1 Agustus 2025 antara PPK-XIX dengan Direktur PT. Moritz Sukses Sejatera perihal Paket Pekerjaan Operations Maintenance Apartemen West Residence, bersama ini dengan hormat kami menyampaikan laporan sebagai berikut:</textarea>
    </header>

    <!-- Bagian A: Waktu Kegiatan (Layout Diperbaiki) -->
    <section class="mb-6">
      <h3 class="section-heading">A. WAKTU KEGIATAN</h3>
      <div class="ml-4 grid grid-cols-1 md:grid-cols-2 gap-x-6">
        <div class="flex items-center">
          <label for="hari-tanggal" class="font-medium text-slate-700 w-32">Hari/Tanggal:</label>
          <input type="text" id="hari-tanggal" class="form-input-line" placeholder="cth: Rabu, 01 Oktober 2025 - Selasa, 07 Oktober 2025">
        </div>
        <div class="flex items-center">
          <label for="periode" class="font-medium text-slate-700 w-32">Periode:</label>
          <input type="text" id="periode" class="form-input-line" placeholder="cth: Minggu ke-1 (Oktober 2025)">
        </div>
      </div>
    </section>

    <!-- Bagian B: Lokasi Kegiatan (Layout Diperbaiki & Center) -->
    <section class="mb-6">
      <h3 class="section-heading">B. LOKASI KEGIATAN</h3>
      <div class="ml-4">
        <textarea class="form-textarea-box text-sm" rows="3" placeholder="[Deskripsi Lokasi - bisa diedit]... Lokasi kegiatan pengelolaan Rusun ASN...">Lokasi kegiatan pengelolaan Rusun ASN 4 West Residence terletak di Kawasan Inti Pusat Pemerintahan IKN dengan koordinat 0°58'30"S 116°41'47"E Rusun ASN West Residence, Tower 1,2,3,4,5,6,7dan 8.</textarea>
        
        <!-- Upload Gambar Kawasan (CENTERED) -->
        <div class="mt-4 flex flex-col items-center">
          <label class="font-medium text-slate-700 mb-2">Upload Gambar Desain Kawasan:</label>
          <input type="file" class="form-input-file no-print" accept="image/*" onchange="previewFile(this, 'gambar-kawasan')">
          <div id="gambar-kawasan" class="image-preview-container hidden mt-2 w-full max-w-2xl">
            <img src="" alt="Preview Gambar Kawasan" class="image-preview !max-h-[400px]">
          </div>
        </div>
      </div>
    </section>

    <!-- Bagian C: Pelaksana -->
    <section class="mb-6">
      <h3 class="section-heading">C. PELAKSANA</h3>
      <div class="ml-4 overflow-x-auto">
        <table class="excel-table min-w-[1000px]">
          <thead>
            <tr>
              <th class="w-12">No</th>
              <th>Departement</th>
              <th>Nama</th>
              <th>Check In</th>
              <th>Check Out</th>
              <th>Upload Absensi Masuk</th>
              <th>Upload Absensi Keluar</th>
              <th class="w-1/4">Keterangan</th>
              <th class="w-16 no-print">Aksi</th>
            </tr>
          </thead>
          <tbody id="personel-table-body">
            <!-- Baris akan ditambahkan oleh JavaScript -->
          </tbody>
        </table>
        <button onclick="addPersonelRow()" class="btn btn-blue mt-4 no-print">+ Tambah Pelaksana</button>
      </div>
    </section>

    <!-- Bagian D: Kegiatan Harian -->
    <section class="mb-6">
      <h3 class="section-heading">D. KEGIATAN HARIAN</h3>
      <div class="ml-4 overflow-x-auto">
        <table class="excel-table min-w-[1000px]">
          <thead>
            <tr>
              <th class="w-12">No</th>
              <th class="w-28">Tanggal</th>
              <th class="w-40">Lokasi/Tower</th>
              <th class="w-1/3">Kegiatan</th>
              <th>Upload Dokumentasi</th>
              <th class="w-16 no-print">Aksi</th>
            </tr>
          </thead>
          <tbody id="kegiatan-table-body">
            <!-- Baris akan ditambahkan oleh JavaScript -->
          </tbody>
        </table>
        <button onclick="addKegiatanRow()" class="btn btn-blue mt-4 no-print">+ Tambah Kegiatan</button>
      </div>
    </section>

    <!-- Bagian E: Hasil Monitoring Kegiatan -->
    <section class="mb-6">
      <h3 class="section-heading">E. HASIL MONITORING KEGIATAN</h3>
      <div class="ml-4 overflow-x-auto">
        <table class="excel-table min-w-[1000px]">
          <thead>
            <tr>
              <th class="w-12">No</th>
              <th class="w-1/4">Kegiatan / Kejadian</th>
              <th class="w-1/4">Capaian</th>
              <th class="w-1/4">Outstanding</th>
              <th class="w-1/4">Saran / Rekomendasi</th>
              <th class="w-16 no-print">Aksi</th>
            </tr>
          </thead>
          <tbody id="monitoring-table-body">
            <!-- Baris akan ditambahkan oleh JavaScript -->
          </tbody>
        </table>
        <button onclick="addMonitoringRow()" class="btn btn-blue mt-4 no-print">+ Tambah Monitoring</button>
      </div>
    </section>

    <!-- Bagian F: Rekapitulasi Eksisting Unit (Dengan Grafik) -->
    <section class="mb-6">
      <h3 class="section-heading">F. REKAPITULASI EKSISTING UNIT</h3>
      <div class="ml-4">
        <!-- Info Site (Bisa Diedit) -->
        <textarea class="form-textarea-box text-sm mb-4" rows="3" placeholder="[Info Site - bisa diedit]... Site: RUSUN ASN 2...">Site: RUSUN ASN 2
Tower Aktif (Tahap Pengelolaan): 1, 4, 7, 5, 6, 8 (Total 6 Tower)
Kapasitas per Tower: 60 Unit
Total Kapasitas Aktif: 360 Unit</textarea>

        <!-- Tabel 1: Catatan Status Harian -->
        <h4 class="font-semibold text-slate-700 mb-2">1. Catatan Status Harian (Per Tower)</h4>
        <div class="overflow-x-auto">
          <table class="excel-table min-w-[1000px]">
            <thead>
              <tr>
                <th class="w-12">No</th>
                <th class="w-32">Tanggal</th>
                <th class="w-24">Tower</th>
                <th>Guest In House</th>
                <th>Saleable Rooms</th>
                <th>Out Of Order (OOO)</th>
                <th class="w-1/3">Keterangan</th>
                <th class="w-16 no-print">Aksi</th>
              </tr>
            </thead>
            <tbody id="harian-table-body">
              <!-- Baris akan ditambahkan oleh JavaScript -->
            </tbody>
          </table>
          <button onclick="addHarianRow()" class="btn btn-blue mt-4 no-print">+ Tambah Catatan Harian</button>
        </div>

        <!-- Tabel 2: Total Rekapitulasi Mingguan -->
        <h4 class="font-semibold text-slate-700 mt-6 mb-2">2. Total Rekapitulasi Mingguan</h4>
        <div class="overflow-x-auto">
          <table class="excel-table">
            <thead>
              <tr>
                <th>Kategori</th>
                <th>Total (Mingguan)</th>
                <th class="w-1/2">Keterangan / Analisis Singkat</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td class="font-medium">Guest In House</td>
                <td><input type="number" id="total-guest" class="table-input" value="0"></td>
                <td rowspan="3"><textarea id="recap-analysis" class="table-textarea" rows="4" placeholder="Analisis singkat dari total mingguan..."></textarea></td>
              </tr>
              <tr>
                <td class="font-medium">Saleable Rooms</td>
                <td><input type="number" id="total-saleable" class="table-input" value="0"></td>
              </tr>
              <tr>
                <td class="font-medium">Out Of Order (OOO)</td>
                <td><input type="number" id="total-ooo" class="table-input" value="0"></td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Grafik -->
        <h4 class="font-semibold text-slate-700 mt-6 mb-2">3. Visualisasi Grafik</h4>
        <div class="flex justify-start gap-4 mb-4 no-print">
          <button onclick="updateRecapChart()" class="btn btn-gray">Update Grafik Total</button>
          <button onclick="updateDailyTrendChart()" class="btn btn-gray">Update Grafik Tren Harian</button>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 p-4 border rounded-lg bg-slate-50">
          <!-- Grafik 1: Rekap Total (Donat) -->
          <div id="recapChartContainer">
            <h5 class="font-medium text-center text-slate-700 mb-2">Grafik Total Rekapitulasi Unit</h5>
            <div class="relative w-full max-w-sm mx-auto h-64">
              <canvas id="recapChart"></canvas>
            </div>
          </div>
          <!-- Grafik 2: Tren Harian (Garis) -->
          <div id="dailyTrendChartContainer">
            <h5 class="font-medium text-center text-slate-700 mb-2">Grafik Tren Status Harian</h5>
            <div class="relative w-full h-64">
              <canvas id="dailyTrendChart"></canvas>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Bagian G: Lembar Evaluasi -->
    <section class="mb-6">
      <div class="flex justify-between items-center mb-4">
        <h3 class="section-heading mb-0 border-b-0 pb-0">G. LEMBAR EVALUASI</h3>
        <button onclick="generateWithAI('evaluasi')" class="btn btn-blue btn-sm no-print flex items-center">
          <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path></svg>
          Generate AI
        </button>
      </div>
      <div class="ml-4">
        <textarea id="evaluasi" class="form-textarea-box" rows="6" placeholder="Tuliskan poin-poin evaluasi untuk minggu ini..."></textarea>
      </div>
    </section>

    <!-- Bagian H: Action Plan -->
    <section class="mb-6">
      <div class="flex justify-between items-center mb-4">
        <h3 class="section-heading mb-0 border-b-0 pb-0">H. ACTION PLAN</h3>
        <button onclick="generateWithAI('actionplan')" class="btn btn-blue btn-sm no-print flex items-center">
          <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path></svg>
          Generate AI
        </button>
      </div>
      <div class="ml-4">
        <textarea id="actionplan" class="form-textarea-box" rows="6" placeholder="Tuliskan rencana tindak lanjut (action plan) untuk minggu depan berdasarkan evaluasi..."></textarea>
      </div>
    </section>

    <!-- Bagian I: Update Jumlah Crew (Dengan Grafik) -->
    <section class="mb-6">
      <h3 class="section-heading">I. UPDATE JUMLAH CREW</h3>
      <div class="ml-4 grid grid-cols-1 md:grid-cols-2 gap-6">
        <!-- Tabel Input Crew -->
        <div class="overflow-x-auto">
          <table class="excel-table">
            <thead>
              <tr>
                <th>Departemen</th>
                <th>Jumlah Crew</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td class="font-medium">Housekeeping</td>
                <td><input type="number" id="crew-housekeeping" class="table-input" value="0"></td>
              </tr>
              <tr>
                <td class="font-medium">Front Office</td>
                <td><input type="number" id="crew-frontoffice" class="table-input" value="0"></td>
              </tr>
              <tr>
                <td class="font-medium">Gardener</td>
                <td><input type="number" id="crew-gardener" class="table-input" value="0"></td>
              </tr>
              <tr>
                <td class="font-medium">Decomposer</td>
                <td><input type="number" id="crew-decomposer" class="table-input" value="0"></td>
              </tr>
              <tr>
                <td class="font-medium">Security</td>
                <td><input type="number" id="crew-security" class="table-input" value="0"></td>
              </tr>
              <tr>
                <td class="font-medium">MEP</td>
                <td><input type="number" id="crew-mep" class="table-input" value="0"></td>
              </tr>
            </tbody>
          </table>
          <button onclick="updateCrewChart()" class="btn btn-gray mt-4 no-print">Update Grafik Crew</button>
        </div>
        <!-- Grafik Crew (Batang) -->
        <div id="crewChartContainer" class="p-4 border rounded-lg bg-slate-50">
          <h5 class="font-medium text-center text-slate-700 mb-2">Grafik Jumlah Crew per Departemen</h5>
          <div class="relative w-full h-64">
             <canvas id="crewChart"></canvas>
          </div>
        </div>
      </div>
    </section>

    <!-- Bagian J: Kesimpulan -->
    <section class="mb-6">
      <div class="flex justify-between items-center mb-4">
        <h3 class="section-heading mb-0 border-b-0 pb-0">J. KESIMPULAN</h3>
        <button onclick="generateWithAI('kesimpulan')" class="btn btn-blue btn-sm no-print flex items-center">
          <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path></svg>
          Generate AI
        </button>
      </div>
      <div class="ml-4">
        <textarea id="kesimpulan" class="form-textarea-box" rows="5" placeholder="Tuliskan kesimpulan dari seluruh kegiatan minggu ini..."></textarea>
      </div>
    </section>

    <!-- Bagian K: Penutup (Layout Horizontal) -->
    <section class="mt-12 pt-8 border-t border-slate-300">
      <div class="ml-4">
        <textarea class="form-textarea-box" rows="4" placeholder="[Paragraf Penutup - bisa diedit]... Demikian laporan mingguan ini kami sampaikan...">Demikian laporan mingguan ini kami sampaikan sebagai bahan monitoring dan evaluasi Pimpinan. Atas perhatiannya, kami ucapkan terima kasih.</textarea>
      </div>

      <!-- TATA LETAK TANDA TANGAN HORIZONTAL BARU -->
      <div class="mt-8 ml-4">
        
        <!-- DIBUAT OLEH (SUPERVISOR) -->
        <h4 class="font-semibold text-slate-700 mb-4">Dibuat oleh:</h4>
        <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-4 mb-8">
          
          <!-- Supervisor 1 -->
          <div class="signature-box">
            <input type="file" class="form-input-file-small no-print" accept="image/*" onchange="previewFile(this, 'ttd-dibuat-1')">
            <div id="ttd-dibuat-1" class="image-preview-container flex-grow hidden">
              <img src="" alt="Preview TTD" class="image-preview object-contain">
            </div>
            <input type="text" class="table-input mt-2" placeholder="Supervisor 1">
          </div>
          
          <!-- Supervisor 2 -->
          <div class="signature-box">
            <input type="file" class="form-input-file-small no-print" accept="image/*" onchange="previewFile(this, 'ttd-dibuat-2')">
            <div id="ttd-dibuat-2" class="image-preview-container flex-grow hidden">
              <img src="" alt="Preview TTD" class="image-preview object-contain">
            </div>
            <input type="text" class="table-input mt-2" placeholder="Supervisor 2">
          </div>
          
          <!-- Supervisor 3 -->
          <div class="signature-box">
            <input type="file" class="form-input-file-small no-print" accept="image/*" onchange="previewFile(this, 'ttd-dibuat-3')">
            <div id="ttd-dibuat-3" class="image-preview-container flex-grow hidden">
              <img src="" alt="Preview TTD" class="image-preview object-contain">
            </div>
            <input type="text" class="table-input mt-2" placeholder="Supervisor 3">
          </div>
          
          <!-- Supervisor 4 -->
          <div class="signature-box">
            <input type="file" class="form-input-file-small no-print" accept="image/*" onchange="previewFile(this, 'ttd-dibuat-4')">
            <div id="ttd-dibuat-4" class="image-preview-container flex-grow hidden">
              <img src="" alt="Preview TTD" class="image-preview object-contain">
            </div>
            <input type="text" class="table-input mt-2" placeholder="Supervisor 4">
          </div>
          
          <!-- Supervisor 5 -->
          <div class="signature-box">
            <input type="file" class="form-input-file-small no-print" accept="image/*" onchange="previewFile(this, 'ttd-dibuat-5')">
            <div id="ttd-dibuat-5" class="image-preview-container flex-grow hidden">
              <img src="" alt="Preview TTD" class="image-preview object-contain">
            </div>
            <input type="text" class="table-input mt-2" placeholder="Supervisor 5">
          </div>
        </div>

        <!-- DIKETAHUI OLEH (MANAJEMEN) -->
        <h4 class="font-semibold text-slate-700 mb-4">Diketahui oleh:</h4>
        <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-4">
          
          <!-- Manager Operasional -->
          <div class="signature-box">
            <input type="file" class="form-input-file-small no-print" accept="image/*" onchange="previewFile(this, 'ttd-diketahui-1')">
            <div id="ttd-diketahui-1" class="image-preview-container flex-grow hidden">
              <img src="" alt="Preview TTD" class="image-preview object-contain">
            </div>
            <input type="text" class="table-input mt-2" placeholder="Manager Operasional">
          </div>
          
          <!-- Team Leader -->
          <div class="signature-box">
            <input type="file" class="form-input-file-small no-print" accept="image/*" onchange="previewFile(this, 'ttd-diketahui-2')">
            <div id="ttd-diketahui-2" class="image-preview-container flex-grow hidden">
              <img src="" alt="Preview TTD" class="image-preview object-contain">
            </div>
            <input type="text" class="table-input mt-2" placeholder="Team Leader">
          </div>
        </div>
      </div>
      
    </section>

  </div>

  <!-- JavaScript untuk Fungsionalitas Dinamis -->
  <script>
    // --- Variabel Global AI ---
    const GEMINI_API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=";
    const API_KEY = ""; // Akan diisi oleh Canvas secara otomatis
    const SYSTEM_PROMPT = "Anda adalah asisten yang membantu menyusun laporan mingguan untuk manajer pengelola rusun. Gunakan bahasa Indonesia yang profesional, formal, dan ringkas. Fokus pada poin-poin kunci.";

    // --- Variabel Global Grafik ---
    let recapChart = null;
    let dailyTrendChart = null;
    let crewChart = null;

    /**
     * Menampilkan preview gambar yang di-upload.
     */
    function previewFile(input, previewContainerId) {
      const file = input.files[0];
      const previewContainer = document.getElementById(previewContainerId);
      if (!previewContainer) {
        console.error(`Preview container with id ${previewContainerId} not found.`);
        return;
      }
      const previewImage = previewContainer.querySelector('img');
      if (!previewImage) {
        console.error(`img tag not found inside ${previewContainerId}.`);
        return;
      }

      if (file) {
        const reader = new FileReader();
        
        reader.onload = function(e) {
          previewImage.src = e.target.result;
          previewContainer.classList.remove('hidden');
          // Untuk signature-box, kita pastikan display flex
          if (previewContainer.parentElement.classList.contains('signature-box')) {
            previewContainer.classList.add('flex');
          }
        }
        
        reader.readAsDataURL(file);
      } else {
        previewImage.src = "";
        previewContainer.classList.add('hidden');
        if (previewContainer.parentElement.classList.contains('signature-box')) {
          previewContainer.classList.remove('flex');
        }
      }
    }

    // --- FUNGSI BARU UNTUK DOWNLOAD HTML ---

    /**
     * Mempersiapkan DOM untuk disimpan dengan menyalin nilai properti ke atribut.
     * Ini PENTING agar nilai input/textarea tersimpan di file HTML.
     */
    function updateFormValuesBeforeSave() {
      // 1. Update Textareas
      document.querySelectorAll('textarea').forEach(textarea => {
        textarea.innerHTML = textarea.value;
      });

      // 2. Update Input (text, number, date, time)
      const inputTypes = ['text', 'number', 'date', 'time', 'hidden'];
      inputTypes.forEach(type => {
        document.querySelectorAll(`input[type="${type}"]`).forEach(input => {
          input.setAttribute('value', input.value);
        });
      });

      // 3. Update Select (Dropdown)
      document.querySelectorAll('select').forEach(select => {
        // Hapus atribut 'selected' lama jika ada
        select.querySelectorAll('option').forEach(opt => opt.removeAttribute('selected'));
        // Tambahkan atribut 'selected' ke opsi yang dipilih
        if (select.selectedIndex >= 0) {
          select.options[select.selectedIndex].setAttribute('selected', 'selected');
        }
      });
    }

    /**
     * Memicu download file HTML dari kondisi halaman saat ini.
     */
    function downloadHTML() {
      // Panggil fungsi helper untuk memastikan semua nilai tersimpan di HTML
      updateFormValuesBeforeSave();

      // Dapatkan judul dokumen (yang bisa diedit) untuk nama file
      let docTitle = document.getElementById('report-title').value.trim();
      let filename = 'laporan_terisi.html';
      if (docTitle) {
        // Ganti karakter yang tidak valid untuk nama file
        filename = docTitle.replace(/[^a-z0-9\s-]/gi, '').replace(/\s+/g, '_') + '.html';
      }

      // Dapatkan seluruh konten HTML
      const htmlContent = document.documentElement.outerHTML;

      // Buat Blob (file dalam memori)
      const blob = new Blob([htmlContent], { type: 'text/html' });

      // Buat link download palsu
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = filename;
      
      // Klik link tersebut secara programatik
      document.body.appendChild(a);
      a.click();
      
      // Hapus link dan URL sementara
      document.body.removeChild(a);
      URL.revokeObjectURL(a.href);

      alert('File HTML Anda sedang di-download!\n\nNama file: ' + filename);
    }


    // --- FUNGSI ASISTEN AI ---

    /**
     * Mengambil konteks dari seluruh laporan untuk diberikan ke AI.
     */
    function getReportContext() {
      let context = "Data Laporan:\n";
      try {
        // Konteks dari Pelaksana (C)
        context += "\n[PELAKSANA]\n";
        const personelRows = document.getElementById('personel-table-body').rows;
        for (const row of personelRows) {
          const dept = row.cells[1].querySelector('input').value;
          const name = row.cells[2].querySelector('input').value;
          const ket = row.cells[7].querySelector('textarea').value;
          if (dept || name) context += `- ${dept || 'N/A'}: ${name || 'N/A'} (Ket: ${ket || 'Hadir'})\n`;
        }

        // Konteks dari Kegiatan (D)
        context += "\n[KEGIATAN HARIAN]\n";
        const kegiatanRows = document.getElementById('kegiatan-table-body').rows;
        for (const row of kegiatanRows) {
          const tgl = row.cells[1].querySelector('input').value;
          const lok = row.cells[2].querySelector('input').value;
          const keg = row.cells[3].querySelector('textarea').value;
          if (keg) context += `- (${tgl || 'N/A'} di ${lok || 'N/A'}): ${keg}\n`;
        }
        
        // Konteks dari Monitoring (E)
        context += "\n[HASIL MONITORING]\n";
        const monitoringRows = document.getElementById('monitoring-table-body').rows;
        for (const row of monitoringRows) {
          const keg = row.cells[1].querySelector('textarea').value;
          const capaian = row.cells[2].querySelector('textarea').value;
          const outstanding = row.cells[3].querySelector('textarea').value;
          const saran = row.cells[4].querySelector('textarea').value;
          if (keg) context += `- Kegiatan: ${keg}\n  Capaian: ${capaian || 'Selesai'}\n  Outstanding: ${outstanding || 'Tidak ada'}\n  Saran: ${saran || 'Tidak ada'}\n`;
        }
        
        // Konteks dari Rekap Unit (F)
        context += "\n[REKAPITULASI UNIT]\n";
        context += `- Guest In House (Total): ${document.getElementById('total-guest').value || 0}\n`;
        context += `- Saleable Rooms (Total): ${document.getElementById('total-saleable').value || 0}\n`;
        context += `- Out Of Order (Total): ${document.getElementById('total-ooo').value || 0}\n`;

        // Konteks dari Evaluasi (G) - jika bukan targetnya
        const evaluasiText = document.getElementById('evaluasi').value;
        if (evaluasiText && targetId !== 'evaluasi') context += `\n[EVALUASI SEBELUMNYA]\n${evaluasiText}\n`;
        
        // Konteks dari Action Plan (H) - jika bukan targetnya
        const actionPlanText = document.getElementById('actionplan').value;
        if (actionPlanText && targetId !== 'actionplan') context += `\n[ACTION PLAN SEBELUMNYA]\n${actionPlanText}\n`;

      } catch (e) {
        console.error("Gagal mengambil konteks:", e);
        context += "Gagal mengambil data dari tabel. Mohon isi data terlebih dahulu.\n";
      }
      return context;
    }

    /**
     * Pemicu utama untuk memanggil AI.
     */
    async function generateWithAI(targetId) {
      const targetTextarea = document.getElementById(targetId);
      if (!targetTextarea) return;

      const aiButton = document.querySelector(`button[onclick="generateWithAI('${targetId}')"]`);
      const originalButtonHTML = aiButton.innerHTML;
      
      let prompt = "";
      const context = getReportContext(targetId); // Kirim targetId untuk skip konteks diri sendiri
      
      if (targetId === 'evaluasi') {
        prompt = `Berdasarkan data berikut:\n${context}\n\nBuatkan poin-poin (bullet points) untuk "LEMBAR EVALUASI" dari laporan ini. Fokus pada masalah, kejadian, dan hal-hal yang 'outstanding'.`;
      } else if (targetId === 'actionplan') {
        prompt = `Berdasarkan data berikut:\n${context}\n\nBuatkan poin-poin (bullet points) untuk "ACTION PLAN" (Rencana Tindak Lanjut) untuk minggu depan. Fokus pada solusi untuk 'outstanding' dan 'saran/rekomendasi' dari monitoring.`;
      } else if (targetId === 'kesimpulan') {
        prompt = `Berdasarkan data berikut:\n${context}\n\nBuatkan "KESIMPULAN" singkat (cukup 1-2 paragraf) dari seluruh laporan mingguan ini. Rangkum capaian utama dan tantangan.`;
      }

      if (!prompt) return;

      // Tampilkan loading
      targetTextarea.value = "Sedang membuat draf AI...\n\nHarap tunggu, ini mungkin perlu beberapa detik.";
      aiButton.disabled = true;
      aiButton.innerHTML = `<span class="spinner"></span> Loading...`;

      try {
        const responseText = await callGeminiAPI(prompt);
        targetTextarea.value = responseText;
      } catch (error) {
        console.error("Error calling Gemini API:", error);
        targetTextarea.value = `Gagal terhubung ke AI: ${error.message}\n\nSilakan coba lagi nanti atau periksa koneksi internet Anda.`;
      } finally {
        // Kembalikan tombol ke normal
        aiButton.disabled = false;
        aiButton.innerHTML = originalButtonHTML;
      }
    }

    /**
     * Fungsi untuk memanggil Gemini API.
     */
    async function callGeminiAPI(prompt) {
      // Implementasi Exponential Backoff
      let retries = 3;
      let delay = 1000;
      
      while (retries > 0) {
        try {
          const payload = {
            contents: [{ parts: [{ text: prompt }] }],
            systemInstruction: {
              parts: [{ text: SYSTEM_PROMPT }]
            },
          };

          const response = await fetch(`${GEMINI_API_URL}${API_KEY}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });

          if (!response.ok) {
            // Jika error 429 (Too Many Requests), coba lagi
            if (response.status === 429) {
              throw new Error("429 Too Many Requests");
            }
            const errorBody = await response.text();
            throw new Error(`HTTP error! status: ${response.status}, body: ${errorBody}`);
          }

          const result = await response.json();
          
          if (result.candidates && result.candidates[0].content && result.candidates[0].content.parts[0].text) {
            return result.candidates[0].content.parts[0].text;
          } else if (result.candidates && result.candidates[0].finishReason === "SAFETY") {
            return "Konten tidak dapat dibuat karena alasan keamanan. Harap ubah input Anda.";
          } else {
            throw new Error("Respon AI tidak valid atau kosong.");
          }
        
        } catch (error) {
          console.warn(`Attempt failed: ${error.message}`);
          retries--;
          if (retries === 0) {
            throw error; // Gagal setelah semua percobaan
          }
          await new Promise(resolve => setTimeout(resolve, delay));
          delay *= 2; // Double delay untuk backoff
        }
      }
    }

  </script>
</body>
</html>
